#!/usr/bin/env php
<?php
declare(strict_types=1);

$root = dirname(__DIR__);
$testsDir = $root . '/vendor/wp-phpunit/wp-phpunit';
$coreDir = getenv('WP_CORE_DIR');
if ($coreDir === false || $coreDir === '') {
    fwrite(STDERR, "WP_CORE_DIR not set.\nExport WP_CORE_DIR=/absolute/path/to/wordpress\n");
    exit(1);
}
$coreDir = rtrim($coreDir, '/');
if (!file_exists($coreDir . '/wp-settings.php')) {
    fwrite(STDERR, "wp-settings.php not found in WP_CORE_DIR={$coreDir}\nEnsure WP_CORE_DIR points to a valid WordPress root.\n");
    exit(1);
}
if (!is_dir($testsDir) && !mkdir($testsDir, 0777, true)) {
    fwrite(STDERR, "Failed to create {$testsDir}\n");
    exit(1);
}
$target = $testsDir . '/wordpress';
if (is_link($target) || file_exists($target)) {
    if (!unlink($target)) {
        fwrite(STDERR, "Failed to remove existing {$target}\n");
        exit(1);
    }
}
if (!symlink($coreDir, $target)) {
    fwrite(STDERR, "Could not create symlink {$target}\n");
    exit(1);
}
if (!file_exists($target . '/wp-settings.php')) {
    fwrite(STDERR, "wp core link failed\n");
    exit(1);
}

echo "Linked {$coreDir} -> {$target}" . PHP_EOL;
