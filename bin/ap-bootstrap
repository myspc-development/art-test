#!/usr/bin/env bash
set -euo pipefail
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
cd "$REPO_ROOT"
NO_E2E="${NO_E2E:-0}"
DB_NAME="${DB_NAME:-wp_tests}"; DB_USER="${DB_USER:-root}"; DB_PASSWORD="${DB_PASSWORD:-}"; DB_HOST="${DB_HOST:-127.0.0.1}"
while [[ $# -gt 0 ]]; do case "$1" in
  --no-e2e) NO_E2E=1; shift;;
  --db-name) DB_NAME="$2"; shift 2;;
  --db-user) DB_USER="$2"; shift 2;;
  --db-pass|--db-password) DB_PASSWORD="$2"; shift 2;;
  --db-host) DB_HOST="$2"; shift 2;;
  *) echo "Unknown option: $1"; exit 2;;
esac; done
have(){ command -v "$1" >/dev/null 2>&1; }
[ -f composer.json ] || cat > composer.json <<'JSON'
{ "name": "local/plugin", "type": "project", "require-dev": { "wp-phpunit/wp-phpunit": "^6" } }
JSON
have php || { echo "Missing php"; exit 1; }
have composer || { echo "Missing composer"; exit 1; }
composer install --no-interaction --prefer-dist
composer require --no-interaction --dev wp-phpunit/wp-phpunit:^6 || true
if [ -f package.json ]; then
  if command -v pnpm >/dev/null 2>&1 && [ -f pnpm-lock.yaml ]; then pnpm i
  elif command -v yarn >/dev/null 2>&1 && [ -f yarn.lock ]; then yarn install --frozen-lockfile
  elif command -v npm  >/dev/null 2>&1; then npm i
  else echo "No Node package manager; skipping JS deps"; fi
fi
mkdir -p vendor/wp-phpunit/wp-phpunit
if [ ! -f vendor/wp-phpunit/wp-phpunit/wp-tests-config.php ]; then
  cat > vendor/wp-phpunit/wp-phpunit/wp-tests-config.php <<PHP
<?php
define( 'DB_NAME',     getenv('DB_NAME') ?: '$DB_NAME' );
define( 'DB_USER',     getenv('DB_USER') ?: '$DB_USER' );
define( 'DB_PASSWORD', getenv('DB_PASSWORD') !== false ? getenv('DB_PASSWORD') : '$DB_PASSWORD' );
define( 'DB_HOST',     getenv('DB_HOST') ?: '$DB_HOST' );
define( 'DB_CHARSET', 'utf8' ); define( 'DB_COLLATE', '' );
$table_prefix = 'wptests_';
define( 'WP_TESTS_DOMAIN', 'example.org' ); define( 'WP_TESTS_EMAIL', 'admin@example.org' );
define( 'WP_TESTS_TITLE', 'WP Tests' ); define( 'WP_PHP_BINARY', 'php' ); define( 'WPLANG', '' );
PHP
  echo "created vendor/wp-phpunit/wp-phpunit/wp-tests-config.php"
fi
export DB_NAME DB_USER DB_PASSWORD DB_HOST NO_E2E
bin/ap all
